<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Bet-O-Bet Digital: Ultimate</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Open+Sans:wght@400;600;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              'alfa': ['"Alfa Slab One"', 'cursive'],
              'sans': ['"Open Sans"', 'sans-serif'],
              'mono': ['"Rajdhani"', 'monospace'],
            },
            colors: {
              'board-red': '#e74c3c',
              'board-blue': '#3498db',
              'board-green': '#2ecc71',
              'board-yellow': '#f1c40f',
              'board-white': '#ecf0f1',
              'board-pink': '#ff69b4',
              // NTD Colors
              'ntd-1': '#d4af37',
              'ntd-5': '#c0c0c0',
              'ntd-10': '#f0e68c',
              'ntd-20': '#daa520',
              'ntd-50': '#b8860b',
              'ntd-100': '#e63946',
              'game-dark': '#0f172a',
              'game-panel': '#1e293b',
              'neon-cyan': '#00f0ff',
              'neon-pink': '#ff0099',
            },
            animation: {
              'spin-slow': 'spin 8s linear infinite',
              'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'float': 'float 6s ease-in-out infinite',
              'grid-scroll': 'gridScroll 20s linear infinite',
            },
            keyframes: {
              float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px)' } },
              gridScroll: {
                '0%': { transform: 'perspective(500px) rotateX(60deg) translateY(0)' },
                '100%': { transform: 'perspective(500px) rotateX(60deg) translateY(50px)' },
              }
            },
            backgroundImage: { 'rainbow': 'linear-gradient(to bottom, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3)' }
          }
        }
      }
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
      /* --- Custom Cursors & Global --- */
      body {
        background-color: #050a10;
        color: #eee;
        overflow-x: hidden;
        cursor: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 3L10.07 19.97L12.58 12.58L19.97 10.07L3 3Z" fill="%2300f0ff" stroke="black" stroke-width="1.5" stroke-linejoin="round"/></svg>') 2 2, auto;
      }
      button, a, .cursor-pointer, input, select {
        cursor: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 3L10.07 19.97L12.58 12.58L19.97 10.07L3 3Z" fill="%2300f0ff" stroke="black" stroke-width="1.5" stroke-linejoin="round"/></svg>') 2 2, pointer;
      }

      /* --- 3D Dice Styles --- */
      .scene { perspective: 800px; display: flex; justify-content: center; align-items: center; }
      .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
      .cube__face {
        position: absolute; width: 100%; height: 100%; border: 2px solid rgba(0,0,0,0.5); border-radius: 12px;
        display: flex; justify-content: center; align-items: center;
        font-family: 'Alfa Slab One', cursive; font-size: 2rem; color: white; text-shadow: 2px 2px 0 #000;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5); backface-visibility: hidden;
      }
      .cube__face--red    { background: #e74c3c; transform: rotateY(  0deg) translateZ(var(--translate-z)); }
      .cube__face--blue   { background: #3498db; transform: rotateY( 90deg) translateZ(var(--translate-z)); }
      .cube__face--yellow { background: #f1c40f; transform: rotateY(180deg) translateZ(var(--translate-z)); }
      .cube__face--green  { background: #2ecc71; transform: rotateY(-90deg) translateZ(var(--translate-z)); }
      .cube__face--white  { background: #ecf0f1; transform: rotateX( 90deg) translateZ(var(--translate-z)); color: #333; text-shadow: none; }
      .cube__face--pink   { background: #ff69b4; transform: rotateX(-90deg) translateZ(var(--translate-z)); }

      @keyframes tumble {
        0% { transform: rotateX(0) rotateY(0) rotateZ(0); }
        25% { transform: rotateX(180deg) rotateY(90deg) rotateZ(45deg); }
        50% { transform: rotateX(360deg) rotateY(180deg) rotateZ(90deg); }
        75% { transform: rotateX(540deg) rotateY(270deg) rotateZ(135deg); }
        100% { transform: rotateX(720deg) rotateY(360deg) rotateZ(180deg); }
      }
      .is-spinning { animation: tumble 0.6s linear infinite; }

      /* --- UI Effects --- */
      .glass-panel { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); }
      .neon-text-glow { text-shadow: 0 0 5px rgba(0, 240, 255, 0.5), 0 0 10px rgba(0, 240, 255, 0.3); }
      .clip-corner-br { clip-path: polygon(0 0, 100% 0, 100% 85%, 85% 100%, 0 100%); }
      
      .tech-border { position: relative; border: 1px solid rgba(0, 240, 255, 0.2); box-shadow: 0 0 15px rgba(0, 240, 255, 0.05); }
      .tech-border::before { content: ''; position: absolute; top: -1px; left: -1px; width: 8px; height: 8px; border-top: 2px solid #00f0ff; border-left: 2px solid #00f0ff; }
      .tech-border::after { content: ''; position: absolute; bottom: -1px; right: -1px; width: 8px; height: 8px; border-bottom: 2px solid #00f0ff; border-right: 2px solid #00f0ff; }

      .scanlines { background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2)); background-size: 100% 4px; pointer-events: none; }
      
      @keyframes winGlow { from { box-shadow: 0 0 10px 2px #ffeb3b; transform: scale(1.05); } to { box-shadow: 0 0 20px 5px #ffd700; transform: scale(1.15); } }
      .chip-win { animation: winGlow 0.8s infinite alternate ease-in-out; z-index: 10; }

      /* Moving Grid Background */
      .perspective-grid { position: absolute; inset: 0; transform: perspective(500px) rotateX(60deg); overflow: hidden; }
      .moving-grid { position: absolute; width: 200%; height: 200%; top: -50%; left: -50%; background-image: linear-gradient(rgba(0, 240, 255, 0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 240, 255, 0.3) 1px, transparent 1px); background-size: 50px 50px; animation: gridScroll 15s linear infinite; opacity: 0.15; }
      
      @keyframes floatUp { 0% { transform: translateY(110vh) rotate(0deg); opacity: 0; } 10% { opacity: 0.8; } 90% { opacity: 0.8; } 100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; } }
      .floating-shape { position: absolute; width: 50px; height: 50px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(2px); animation: floatUp 15s linear infinite; z-index: 0; }

      .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const uuidv4 = () => Math.random().toString(36).substr(2, 9);
        const STORAGE_KEY = 'bet_o_bet_users_db_v1';

        // --- 1. CONSTANTS & CONFIG ---
        const GameColor = { RED: 'red', BLUE: 'blue', GREEN: 'green', YELLOW: 'yellow', WHITE: 'white', PINK: 'pink' };
        const COLORS = [GameColor.RED, GameColor.BLUE, GameColor.GREEN, GameColor.YELLOW, GameColor.WHITE, GameColor.PINK];
        const CHIP_VALUES = [1, 5, 10, 20, 50, 100];
        
        const COLOR_TAILWIND_MAP = {
            [GameColor.RED]: 'bg-board-red', [GameColor.BLUE]: 'bg-board-blue', [GameColor.GREEN]: 'bg-board-green',
            [GameColor.YELLOW]: 'bg-board-yellow', [GameColor.WHITE]: 'bg-board-white', [GameColor.PINK]: 'bg-board-pink'
        };
        
        const PLAYER_THEMES = {
            cyan: { text: 'text-cyan-400', bg: 'bg-cyan-900', border: 'border-cyan-400', shadow: 'shadow-cyan-400/50', gradient: 'from-cyan-500 to-blue-500' },
            pink: { text: 'text-pink-400', bg: 'bg-pink-900', border: 'border-pink-400', shadow: 'shadow-pink-400/50', gradient: 'from-pink-500 to-rose-500' },
            green: { text: 'text-green-400', bg: 'bg-green-900', border: 'border-green-400', shadow: 'shadow-green-400/50', gradient: 'from-green-500 to-emerald-500' },
            orange: { text: 'text-orange-400', bg: 'bg-orange-900', border: 'border-orange-400', shadow: 'shadow-orange-400/50', gradient: 'from-orange-500 to-amber-500' }
        };

        // --- 2. COMPONENTS ---

        // --- CHIP COMPONENT (Complex Visuals) ---
        const Chip = ({ value, isWin, ownerColorClass }) => {
            const isCoin = value < 100;
            const isBill = value >= 100;
            let baseStyle = '', innerStyle = '', textStyle = 'text-white drop-shadow-md font-serif';

            switch (value) {
                case 1: baseStyle = 'bg-gradient-to-br from-[#d4af37] via-[#b8860b] to-[#8b4513] border-[#8b4513]'; textStyle = 'text-[#5c3a12] font-bold'; break;
                case 5: baseStyle = 'bg-gradient-to-br from-[#e0e0e0] via-[#c0c0c0] to-[#909090] border-[#707070]'; textStyle = 'text-[#404040] font-bold'; break;
                case 10: baseStyle = 'bg-gradient-to-br from-[#f9e79f] via-[#f1c40f] to-[#b7950b] border-[#9a7d0a]'; textStyle = 'text-[#7d6608] font-bold'; break;
                case 20: baseStyle = 'bg-gradient-to-br from-[#e0e0e0] via-[#c0c0c0] to-[#909090] border-[#d4af37]'; innerStyle = 'radial-gradient(circle, #f1c40f 60%, transparent 61%)'; textStyle = 'text-[#7d6608] font-bold'; break;
                case 50: baseStyle = 'bg-gradient-to-br from-[#ffdf00] via-[#daa520] to-[#b8860b] border-[#8b4513]'; textStyle = 'text-[#5c3a12] font-bold'; break;
                case 100: baseStyle = 'bg-red-600 bg-none'; textStyle = 'text-white font-mono tracking-widest'; break;
                default: baseStyle = 'bg-gray-700';
            }

            const borderSize = ownerColorClass ? (isCoin ? 'border-[3px]' : 'border-[3px]') : (isCoin ? 'border-b-[3px] border-r-[3px] border-t border-l' : 'border-none');
            const ownerRing = ownerColorClass ? `ring-2 ${ownerColorClass} ring-offset-1 ring-offset-black` : '';
            const coinShadow = isCoin ? 'shadow-[inset_0_2px_5px_rgba(255,255,255,0.4),0_4px_6px_rgba(0,0,0,0.6)]' : 'shadow-lg';
            const billPattern = isBill ? 'bg-[linear-gradient(45deg,transparent_25%,rgba(255,255,255,0.1)_25%,rgba(255,255,255,0.1)_50%,transparent_50%,transparent_75%,rgba(255,255,255,0.1)_75%,rgba(255,255,255,0.1)_100%)] bg-[length:4px_4px]' : '';

            return (
                <div className={`relative flex items-center justify-center select-none transition-transform duration-300 ${isCoin ? 'rounded-full w-9 h-9 sm:w-11 sm:h-11' : 'rounded-sm w-14 h-7 sm:w-16'} ${baseStyle} ${borderSize} ${coinShadow} ${billPattern} ${isWin ? 'chip-win brightness-125' : ''} ${ownerRing}`} style={value === 20 ? { background: innerStyle, backgroundColor: '#c0c0c0' } : {}}>
                    {isCoin && <div className="absolute inset-0 rounded-full bg-gradient-to-tr from-white/40 via-transparent to-black/20 pointer-events-none" />}
                    {isCoin && value !== 20 && <div className="absolute inset-1 rounded-full border border-black/10 pointer-events-none"></div>}
                    {isBill && <div className="absolute right-2 top-0 bottom-0 w-1 sm:w-2 bg-gradient-to-b from-white/30 via-rainbow to-white/30 opacity-50"></div>}
                    <span className={`relative z-10 text-xs sm:text-sm ${textStyle}`}>{isBill ? 'üíØ' : value}</span>
                    {isBill && <span className="absolute left-1 top-0 text-[8px] text-white/80 font-bold font-sans">100</span>}
                </div>
            );
        };

        // --- DIE COMPONENT (Using User CSS) ---
        const Die = ({ color, isRolling }) => {
            const getTransform = (c) => {
                if (!c) return 'rotateX(0deg) rotateY(0deg)';
                switch (c) {
                    case 'red': return 'rotateY(0deg)'; case 'blue': return 'rotateY(-90deg)'; case 'green': return 'rotateY(90deg)';
                    case 'yellow': return 'rotateY(180deg)'; case 'white': return 'rotateX(-90deg)'; case 'pink': return 'rotateX(90deg)';
                    default: return 'rotateY(0deg)';
                }
            };
            return (
                <div className="scene w-16 h-16 sm:w-24 sm:h-24">
                    <div className={`cube ${isRolling ? 'is-spinning' : ''}`} style={{ transform: isRolling ? undefined : getTransform(color), '--translate-z': '3rem' }}>
                        <div className="cube__face cube__face--red">R</div><div className="cube__face cube__face--blue">B</div><div className="cube__face cube__face--green">G</div>
                        <div className="cube__face cube__face--yellow">Y</div><div className="cube__face cube__face--white">W</div><div className="cube__face cube__face--pink">P</div>
                    </div>
                    <style>{`@media (max-width: 640px) { .cube { --translate-z: 2rem; } }`}</style>
                </div>
            );
        };

        // --- CONTROLS COMPONENT (Mechanical Tray) ---
        const Controls = ({ selectedChip, onSelectChip, onRoll, onClear, onNewRound, onUndo, onDouble, canRoll, canClear, canUndo, canDouble, roundActive, activePlayer }) => {
            const theme = PLAYER_THEMES[activePlayer.theme];
            return (
                <div className="w-full flex flex-col gap-4 sm:gap-6 bg-gray-900 p-4 sm:p-6 rounded-xl relative overflow-hidden transition-colors duration-500 border border-gray-700 shadow-2xl">
                    <div className={`absolute top-0 left-0 right-0 h-1.5 bg-gradient-to-r ${theme.gradient} shadow-[0_0_20px_currentColor]`}></div>
                    <div className="flex flex-col gap-3">
                        <div className={`flex items-center justify-between ${theme.text} text-xs uppercase font-mono tracking-[0.2em] font-bold`}><span className="flex items-center gap-2"><div className="w-2 h-2 bg-current rounded-full animate-pulse"></div> SELECT WAGER</span><span className="bg-black px-3 py-1 rounded border border-gray-600">{activePlayer.name}</span></div>
                        <div className="bg-black rounded-xl p-4 border border-gray-700 shadow-inner flex justify-center inset-shadow">
                            <div className="flex flex-wrap justify-center gap-4 sm:gap-6">
                                {CHIP_VALUES.map((val) => (
                                    <button key={val} disabled={!roundActive} onClick={() => onSelectChip(val)} className={`group relative flex flex-col items-center justify-center transition-all duration-200 ${selectedChip === val ? 'scale-125 z-10 brightness-110' : 'opacity-80 hover:opacity-100 hover:scale-110 grayscale-[0.2]'} ${!roundActive ? 'opacity-40 grayscale cursor-not-allowed' : ''}`}>
                                        <div className="relative drop-shadow-xl"><Chip value={val} />{selectedChip === val && <div className={`absolute -bottom-4 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 rounded-full ${theme.bg} shadow-[0_0_10px_currentColor]`}></div>}</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="h-px bg-gray-700 w-full" />
                    {roundActive && (
                        <div className="flex gap-3 justify-center">
                            <button onClick={onUndo} disabled={!canUndo} className={`px-6 py-2.5 rounded-sm skew-x-[-12deg] text-xs font-mono uppercase tracking-wider border transition-all shadow-lg ${canUndo ? 'bg-gray-800 border-gray-500 hover:bg-gray-700 text-gray-200 hover:border-cyan-400 hover:text-white' : 'bg-gray-900 border-gray-800 text-gray-600 cursor-not-allowed'}`}><span className="skew-x-[12deg] block font-bold">‚Ü© Undo</span></button>
                            <button onClick={onDouble} disabled={!canDouble} className={`px-6 py-2.5 rounded-sm skew-x-[-12deg] text-xs font-mono uppercase tracking-wider border transition-all shadow-lg ${canDouble ? 'bg-yellow-900 border-yellow-600 hover:bg-yellow-800 text-yellow-400 hover:shadow-[0_0_15px_rgba(234,179,8,0.4)] hover:text-white' : 'bg-gray-900 border-gray-800 text-gray-600 cursor-not-allowed'}`}><span className="skew-x-[12deg] block font-bold">√ó2 Double</span></button>
                        </div>
                    )}
                    <div className="flex flex-col gap-3">
                        {!roundActive ? (
                            <button onClick={onNewRound} className="btn-game w-full py-5 bg-gradient-to-r from-blue-700 to-blue-600 hover:from-blue-600 hover:to-blue-500 active:scale-[0.99] text-white font-alfa text-xl sm:text-2xl rounded-lg shadow-lg transition-all uppercase tracking-widest border-t border-white/20 relative overflow-hidden"><div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTEgMWgydjJIMXoiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPjwvc3ZnPg==')] opacity-30"></div>OPEN BETTING PHASE</button>
                        ) : (
                            <div className="flex gap-3 sm:gap-4">
                                <button onClick={onClear} disabled={!canClear} className={`btn-game flex-1 py-4 font-mono font-bold text-sm sm:text-lg rounded-lg transition-all border-b-4 shadow-lg ${canClear ? 'bg-red-900 border-red-700 text-red-100 hover:bg-red-800 hover:border-red-600 hover:shadow-[0_0_20px_rgba(220,38,38,0.6)] active:translate-y-1 active:border-b-0' : 'bg-gray-800 border-gray-900 text-gray-600 cursor-not-allowed'}`}>CLEAR</button>
                                <button onClick={onRoll} disabled={!canRoll} className={`btn-game flex-[2] py-4 font-alfa text-2xl sm:text-3xl rounded-lg transition-all border-b-4 relative overflow-hidden shadow-xl ${canRoll ? 'bg-green-600 border-green-800 text-white hover:bg-green-500 hover:border-green-700 hover:shadow-[0_0_30px_rgba(22,163,74,0.6)] active:translate-y-1 active:border-b-0' : 'bg-gray-800 border-gray-900 text-gray-600 cursor-not-allowed'}`}><div className="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent pointer-events-none"></div>ROLL DICE</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- BETTING SQUARES ---
        const BettingSquare = ({ color, bets, players, activePlayer, onPlaceBet, disabled, isWinner }) => {
            const totalBet = bets.reduce((sum, bet) => sum + bet.amount, 0);
            const textColor = color === GameColor.WHITE ? 'text-gray-900' : 'text-white';
            const bgClass = COLOR_TAILWIND_MAP[color];
            const hoverClasses = { cyan: 'group-hover:shadow-[0_0_30px_rgba(34,211,238,0.8)] group-hover:border-cyan-400', pink: 'group-hover:shadow-[0_0_30px_rgba(244,114,182,0.8)] group-hover:border-pink-400', green: 'group-hover:shadow-[0_0_30px_rgba(74,222,128,0.8)] group-hover:border-green-400', orange: 'group-hover:shadow-[0_0_30px_rgba(251,146,60,0.8)] group-hover:border-orange-400' };
            const playerHoverClass = (!disabled && activePlayer) ? hoverClasses[activePlayer.theme] : '';
            const activeBorder = isWinner ? 'border-yellow-400 shadow-[0_0_50px_rgba(234,179,8,0.8)] z-10 scale-[1.02]' : 'border-white/20';
            const getPlayerThemeBorder = (pid) => { const p = players.find(pl => pl.id === pid); return p ? PLAYER_THEMES[p.theme].border : 'border-gray-500'; };

            return (
                <div onClick={() => !disabled && onPlaceBet(color)} className={`group relative aspect-square rounded-md flex flex-col items-center justify-between p-1 sm:p-2 transition-all duration-200 ease-out border-2 ${activeBorder} ${disabled ? 'opacity-70 grayscale-[0.5] cursor-not-allowed bg-gray-900' : `cursor-pointer hover:-translate-y-1 ${playerHoverClass} bg-gray-800`}`}>
                    <div className={`absolute inset-0 opacity-60 transition-opacity group-hover:opacity-80 ${bgClass}`}></div><div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIiBmaWxsPSJub25lIiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC4xNSkiPjxwYXRoIGQ9Ik0xIDFoMnYySDF6Ii8+PC9zdmc+')] opacity-50 pointer-events-none"></div>
                    <div className={`absolute inset-0 bg-gradient-to-b from-white/5 to-${color === 'white' ? 'gray-200' : color+'-500'}/40 pointer-events-none`}></div>
                    <div className="absolute top-0 left-0 w-3 h-3 border-t-2 border-l-2 border-white/50 group-hover:border-white transition-all"></div><div className="absolute top-0 right-0 w-3 h-3 border-t-2 border-r-2 border-white/50 group-hover:border-white transition-all"></div><div className="absolute bottom-0 left-0 w-3 h-3 border-b-2 border-l-2 border-white/50 group-hover:border-white transition-all"></div><div className="absolute bottom-0 right-0 w-3 h-3 border-b-2 border-r-2 border-white/50 group-hover:border-white transition-all"></div>
                    <div className="relative z-10 w-full text-center py-1.5 bg-black/80 border-b border-white/20 shadow-md rounded-t-sm"><span className={`font-alfa text-sm sm:text-lg uppercase tracking-[0.15em] drop-shadow-md ${color === 'white' ? 'text-white bg-gray-700 px-2 rounded' : textColor}`}>{color}</span></div>
                    <div className="relative z-10 flex-1 w-full flex flex-col-reverse flex-wrap content-center justify-center gap-[-5px] p-1 pointer-events-none">{bets.map((bet, i) => (<div key={bet.id} className="transform transition-all hover:scale-110 -mb-4 sm:-mb-5 last:mb-0" style={{zIndex: i}}><Chip value={bet.amount} isWin={isWinner} ownerColorClass={getPlayerThemeBorder(bet.playerId)}/></div>))}</div>
                    <div className="relative z-10 w-full mt-2"><div className="flex items-center justify-between bg-gray-900 border border-white/20 rounded px-2 py-1.5 shadow-lg group-hover:bg-black transition-colors"><span className="font-mono text-[10px] sm:text-xs text-gray-400">BET</span><span className="font-mono font-bold text-xs sm:text-sm text-neon-cyan">NT$ {totalBet}</span></div><div className="flex justify-end mt-1 h-1.5 gap-1.5 px-1">{Array.from(new Set(bets.map(b => b.playerId))).map(pid => {const p = players.find(pl => pl.id === pid); if(!p) return null; return <div key={pid} className={`w-2.5 h-1.5 rounded-full ${PLAYER_THEMES[p.theme].bg} border border-white/30 shadow-[0_0_5px_currentColor]`}></div>})}</div></div>
                </div>
            );
        };

        const SideBetSquare = ({ type, bets, players, activePlayer, onPlaceBet, disabled, isWinner, payoutText }) => {
            const totalBet = bets.reduce((sum, bet) => sum + bet.amount, 0);
            const getPlayerThemeBorder = (pid) => { const p = players.find(pl => pl.id === pid); return p ? PLAYER_THEMES[p.theme].border : 'border-gray-500'; };
            const hoverClasses = { cyan: 'hover:border-cyan-400 hover:shadow-[0_0_20px_rgba(34,211,238,0.6)]', pink: 'hover:border-pink-400 hover:shadow-[0_0_20px_rgba(244,114,182,0.6)]', green: 'hover:border-green-400 hover:shadow-[0_0_20px_rgba(74,222,128,0.6)]', orange: 'hover:border-orange-400 hover:shadow-[0_0_20px_rgba(251,146,60,0.6)]' };
            const playerHoverClass = (!disabled && activePlayer) ? hoverClasses[activePlayer.theme] : '';
            return (
                <div onClick={() => !disabled && onPlaceBet(type)} className={`relative h-full min-h-[110px] rounded-xl flex flex-col items-center justify-between p-2 sm:p-4 border-2 transition-all duration-200 ${isWinner ? 'bg-purple-900 border-purple-300 shadow-[0_0_40px_rgba(168,85,247,0.8)] scale-105 z-10' : 'bg-gray-900 border-purple-800'} ${disabled ? 'opacity-70 cursor-not-allowed bg-gray-900' : `cursor-pointer active:scale-95 hover:bg-purple-900 ${playerHoverClass}`}`}>
                    <div className="text-center w-full border-b border-white/10 pb-2"><span className={`block font-alfa text-sm sm:text-lg uppercase tracking-wider ${isWinner ? 'text-white' : 'text-purple-300'}`}>ANY {type}</span><span className="block font-mono text-[11px] text-purple-400 font-bold tracking-widest mt-1 bg-black/50 rounded px-2">PAYOUT {payoutText}</span></div>
                    <div className="flex-1 w-full flex flex-col-reverse flex-wrap content-center justify-center gap-1 p-1 pointer-events-none overflow-hidden my-2">{bets.map((bet, i) => (<div key={bet.id} className="transform transition-all hover:scale-110" style={{zIndex: i}}><Chip value={bet.amount} isWin={isWinner} ownerColorClass={getPlayerThemeBorder(bet.playerId)} /></div>))}</div>
                    <div className="bg-black text-purple-100 px-3 py-1.5 rounded text-xs font-mono border border-purple-700 w-full text-center shadow-inner font-bold">NT$ {totalBet}</div>
                </div>
            );
        };

        // MODALS
        const HistoryModal = ({ isOpen, onClose, history }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm" onClick={onClose}>
                    <div className="relative w-full max-w-xl bg-gray-900 tech-border flex flex-col max-h-[85vh] overflow-hidden" onClick={e=>e.stopPropagation()}>
                        <div className="absolute inset-0 scanlines opacity-20 pointer-events-none z-10"></div>
                        <div className="flex items-center justify-between p-4 bg-black/50 border-b border-gray-700 z-20"><div className="flex items-center gap-2"><div className="w-2 h-6 bg-yellow-500 animate-pulse"></div><h2 className="text-xl font-mono font-bold text-yellow-400 tracking-[0.2em] uppercase">Mission Logs</h2></div><button onClick={onClose} className="text-gray-500 hover:text-red-400 font-mono">[X] Close</button></div>
                        <div className="overflow-y-auto p-4 flex flex-col gap-2 scrollbar-hide z-20 bg-gray-900/50">
                            <div className="flex justify-between px-4 pb-2 border-b border-gray-700 text-[10px] font-mono uppercase text-gray-500 tracking-widest"><span>SEQ. ID</span><span>Dice Telemetry</span><span>Outcome</span></div>
                            {history.length === 0 ? <div className="text-center text-gray-600 py-12 font-mono uppercase">// No data recorded //</div> : history.map((entry) => {
                                const uniqueWinners = Array.from(new Set(entry.diceResults));
                                return (
                                    <div key={entry.id} className="bg-black/40 hover:bg-white/5 border border-white/5 hover:border-neon-cyan/30 rounded-sm p-3 flex items-center justify-between transition-colors group">
                                        <div className="flex flex-col gap-1 min-w-[60px]"><span className="text-[10px] text-neon-cyan font-mono group-hover:text-white">#{entry.roundNumber.toString().padStart(4, '0')}</span><span className="text-[9px] text-gray-600 font-mono">{new Date(entry.timestamp).toLocaleTimeString()}</span></div>
                                        <div className="flex gap-2">{entry.diceResults.map((color, idx) => <div key={idx} className={`w-6 h-6 rounded-sm border border-black/50 shadow-sm ${COLOR_TAILWIND_MAP[color]}`} />)}</div>
                                        <div className="text-right w-[140px] font-mono text-xs">{uniqueWinners.length > 0 ? <span className="text-gray-300 group-hover:text-yellow-400 transition-colors">MATCH: {uniqueWinners.map(c => c.substring(0,3).toUpperCase()).join('-')}</span> : <span className="text-gray-600">NO MATCH</span>}</div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const StatsModal = ({ isOpen, onClose, walletHistory, username }) => {
            if (!isOpen) return null;
            const width = 600, height = 300, padding = 40;
            const dataPoints = walletHistory.length > 0 ? walletHistory : [1000];
            const maxVal = Math.max(...dataPoints, 1000) * 1.1;
            const minVal = Math.max(0, Math.min(...dataPoints) * 0.9);
            const getX = (i) => dataPoints.length<=1 ? padding : padding + (i / (dataPoints.length - 1)) * (width - padding * 2);
            const getY = (v) => { const r = maxVal - minVal; return r===0 ? height/2 : height - padding - ((v - minVal) / r) * (height - padding * 2); };
            const points = dataPoints.map((val, i) => `${getX(i)},${getY(val)}`).join(' ');

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md" onClick={onClose}>
                    <div className="relative w-full max-w-3xl bg-gray-900 tech-border flex flex-col animate-in fade-in zoom-in-95 duration-200 overflow-hidden" onClick={e=>e.stopPropagation()}>
                        <div className="absolute inset-0 scanlines opacity-20 pointer-events-none z-10"></div>
                        <div className="flex items-center justify-between p-5 border-b border-gray-700 bg-black/40 z-20"><div className="flex items-center gap-3"><div className="w-3 h-3 bg-neon-cyan animate-pulse"></div><div><h2 className="text-xl font-mono font-bold text-white tracking-[0.2em] uppercase">Financial Analytics</h2><p className="text-[10px] font-mono text-neon-cyan uppercase">Subject: {username}</p></div></div><button onClick={onClose} className="text-gray-500 hover:text-white font-mono">[ CLOSE TERMINAL ]</button></div>
                        <div className="p-6 bg-gray-900 z-20">
                            <div className="relative w-full aspect-video bg-black rounded-sm border border-gray-700 shadow-inner overflow-hidden">
                                <div className="absolute inset-0" style={{backgroundImage: 'linear-gradient(#111 1px, transparent 1px), linear-gradient(90deg, #111 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                                <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full relative z-10">
                                    {[0,0.25,0.5,0.75,1].map(p=>{ const y = height-padding-(p*(height-padding*2)); return <line key={p} x1={padding} y1={y} x2={width-padding} y2={y} stroke="#1f2937" strokeWidth="1" strokeDasharray="4 4"/> })}
                                    <polyline fill="none" stroke="#00f0ff" strokeWidth="2" points={points} strokeLinecap="square" strokeLinejoin="bevel" className="drop-shadow-[0_0_5px_rgba(0,240,255,0.8)]" />
                                    <polyline fill="rgba(0, 240, 255, 0.1)" stroke="none" points={`${getX(0)},${height-padding} ${points} ${getX(dataPoints.length-1)},${height-padding}`} />
                                    {dataPoints.map((val, i) => <circle key={i} cx={getX(i)} cy={getY(val)} r="3" className="fill-black stroke-neon-cyan stroke-[2px] hover:r-5 transition-all cursor-crosshair"><title>Round {i}: NT$ {val}</title></circle>)}
                                </svg>
                                <div className="absolute top-0 bottom-0 left-0 w-10 flex flex-col justify-between py-[35px] text-[9px] font-mono text-gray-500 text-right pr-2"><span>{Math.round(maxVal)}</span><span>{Math.round((maxVal+minVal)/2)}</span><span>{Math.round(minVal)}</span></div>
                            </div>
                            <div className="mt-6 flex justify-between font-mono text-xs uppercase tracking-wider"><div className="text-gray-400">Initial: <span className="text-white">NT$ {walletHistory[0]}</span></div><div className="text-gray-400">Current: <span className="text-neon-cyan font-bold drop-shadow-md">NT$ {walletHistory[walletHistory.length - 1]}</span></div></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- GAME ENGINE ---
        const INITIAL_WALLET = 1000;
        const INITIAL_JACKPOT = 10000;

        const Game = ({ initialPlayers, currentUser, onSync, onExit }) => {
            const [players, setPlayers] = useState(initialPlayers);
            const [activePlayerId, setActivePlayerId] = useState(initialPlayers[0].id);
            const [history, setHistory] = useState(currentUser ? currentUser.history : []);
            const [walletHistory, setWalletHistory] = useState(currentUser ? currentUser.walletHistory : [INITIAL_WALLET]);
            const [bets, setBets] = useState({ red: [], blue: [], green: [], yellow: [], white: [], pink: [] });
            const [sideBets, setSideBets] = useState({ PAIR: [], TRIPLE: [] });
            const [betStack, setBetStack] = useState([]);
            const [jackpot, setJackpot] = useState(INITIAL_JACKPOT);
            const [isRolling, setIsRolling] = useState(false);
            const [roundActive, setRoundActive] = useState(false);
            const [diceResults, setDiceResults] = useState([GameColor.RED, GameColor.BLUE, GameColor.GREEN]);
            const [message, setMessage] = useState("WAITING FOR BETS...");
            const [winningColors, setWinningColors] = useState([]);
            const [winningSideBets, setWinningSideBets] = useState([]);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);
            const [isStatsOpen, setIsStatsOpen] = useState(false);
            const [selectedChip, setSelectedChip] = useState(1);

            const activePlayer = players.find(p => p.id === activePlayerId) || players[0];
            const totalBetAmount = Object.values(bets).flat().reduce((acc, b) => acc + b.amount, 0) + Object.values(sideBets).flat().reduce((acc, b) => acc + b.amount, 0);

            const { hotColor, coldColor } = useMemo(() => {
                if (history.length < 5) return { hotColor: null, coldColor: null };
                const counts = {}; COLORS.forEach(c => counts[c] = 0);
                history.slice(0, 50).forEach(entry => entry.diceResults.forEach(color => counts[color]++));
                let hot = COLORS[0], cold = COLORS[0], max = -1, min = Infinity;
                COLORS.forEach(c => { if (counts[c] > max) { max = counts[c]; hot = c; } if (counts[c] < min) { min = counts[c]; cold = c; } });
                return max === min ? { hotColor: null, coldColor: null } : { hotColor: hot, coldColor: cold };
            }, [history]);

            useEffect(() => {
                if (currentUser) {
                    const host = players.find(p => !p.isGuest);
                    if (host && (host.wallet !== currentUser.wallet || history.length !== currentUser.history.length)) {
                        onSync({ wallet: host.wallet, history: history, walletHistory: walletHistory });
                    }
                }
            }, [players, history, walletHistory, currentUser, onSync]);

            const startNewRound = () => { setWinningColors([]); setWinningSideBets([]); setBets({ red:[], blue:[], green:[], yellow:[], white:[], pink:[] }); setSideBets({ PAIR:[], TRIPLE:[] }); setBetStack([]); setRoundActive(true); setMessage("BETS OPEN. GOOD LUCK!"); };
            const placeBet = (color) => { if (!roundActive || isRolling) return; performBet(selectedChip, { color }); };
            const placeSideBet = (type) => { if (!roundActive || isRolling) return; performBet(selectedChip, { sideBet: type }); };
            
            const performBet = (amount, target) => {
                if (activePlayer.wallet >= amount) {
                    setPlayers(prev => prev.map(p => p.id === activePlayerId ? { ...p, wallet: p.wallet - amount } : p));
                    setJackpot(prev => prev + Math.ceil(amount * 0.05));
                    const newBet = { id: uuidv4(), amount: amount, color: target.color, sideBet: target.sideBet, playerId: activePlayerId, timestamp: Date.now() };
                    setBetStack(prev => [...prev, newBet.id]);
                    if (target.color) setBets(prev => ({ ...prev, [target.color]: [...prev[target.color], newBet] }));
                    else setSideBets(prev => ({ ...prev, [target.sideBet]: [...prev[target.sideBet], newBet] }));
                } else { setMessage(`INSUFFICIENT FUNDS FOR ${activePlayer.name}`); setTimeout(() => setMessage("BETS OPEN."), 1500); }
            };

            const undoLastBet = () => {
                if (betStack.length === 0) return;
                const lastBetId = betStack[betStack.length - 1];
                let foundBet, locationKey, betLocation;
                COLORS.forEach(c => { const b = bets[c].find(x => x.id === lastBetId); if(b) { foundBet = b; betLocation = 'color'; locationKey = c; } });
                if(!foundBet) ['PAIR','TRIPLE'].forEach(t => { const b = sideBets[t].find(x => x.id === lastBetId); if(b) { foundBet = b; betLocation = 'side'; locationKey = t; } });

                if (foundBet && foundBet.playerId === activePlayerId) {
                    setPlayers(prev => prev.map(p => p.id === activePlayerId ? { ...p, wallet: p.wallet + foundBet.amount } : p));
                    setJackpot(prev => prev - Math.ceil(foundBet.amount * 0.05));
                    if (betLocation === 'color') setBets(prev => ({ ...prev, [locationKey]: prev[locationKey].filter(b => b.id !== lastBetId) }));
                    else setSideBets(prev => ({ ...prev, [locationKey]: prev[locationKey].filter(b => b.id !== lastBetId) }));
                    setBetStack(prev => prev.slice(0, -1));
                } else { setMessage("CAN ONLY UNDO YOUR OWN LAST ACTION"); setTimeout(() => setMessage("BETS OPEN."), 1500); }
            };

            const doubleBets = () => {
                const pb = Object.values(bets).flat().filter(b => b.playerId === activePlayerId).concat(Object.values(sideBets).flat().filter(b => b.playerId === activePlayerId));
                const total = pb.reduce((s, b) => s + b.amount, 0);
                if (total === 0) return;
                if (activePlayer.wallet >= total) {
                    setPlayers(prev => prev.map(p => p.id === activePlayerId ? { ...p, wallet: p.wallet - total } : p));
                    setJackpot(prev => prev + Math.ceil(total * 0.05));
                    const nb = { ...bets }, ns = { ...sideBets };
                    pb.forEach(b => {
                        const newB = { ...b, id: uuidv4(), timestamp: Date.now() };
                        setBetStack(prev => [...prev, newB.id]);
                        if (b.color) nb[b.color] = [...nb[b.color], newB]; else ns[b.sideBet] = [...ns[b.sideBet], newB];
                    });
                    setBets(nb); setSideBets(ns); setMessage("BETS DOUBLED!");
                } else { setMessage("INSUFFICIENT FUNDS TO DOUBLE"); setTimeout(() => setMessage("BETS OPEN."), 1500); }
            };

            const clearAllBets = () => {
                if (!roundActive || isRolling) return;
                const np = [...players];
                COLORS.forEach(c => bets[c].forEach(b => { const idx = np.findIndex(p => p.id === b.playerId); if(idx !== -1) np[idx].wallet += b.amount; }));
                ['PAIR','TRIPLE'].forEach(t => sideBets[t].forEach(b => { const idx = np.findIndex(p => p.id === b.playerId); if(idx !== -1) np[idx].wallet += b.amount; }));
                setPlayers(np); setBets({ red: [], blue: [], green: [], yellow: [], white: [], pink: [] }); setSideBets({ PAIR: [], TRIPLE: [] }); setBetStack([]); setMessage("TABLE CLEARED.");
            };

            const rollDice = () => {
                if (totalBetAmount === 0) { setMessage("NO BETS PLACED."); return; }
                setRoundActive(false); setIsRolling(true); setMessage("ROLLING...");
                setTimeout(() => {
                    const res = [COLORS[Math.floor(Math.random() * 6)], COLORS[Math.floor(Math.random() * 6)], COLORS[Math.floor(Math.random() * 6)]];
                    setDiceResults(res); setIsRolling(false); calculateWinnings(res);
                }, 2500);
            };

            const calculateWinnings = (results) => {
                const winners = Array.from(new Set(results)); setWinningColors(winners);
                const counts = {}; results.forEach(c => counts[c] = (counts[c] || 0) + 1);
                const isTriple = Object.values(counts).some(c => c === 3), isPair = Object.values(counts).some(c => c >= 2);
                const sides = []; if (isTriple) sides.push('TRIPLE'); if (isPair) sides.push('PAIR'); setWinningSideBets(sides);
                const isJackpot = isTriple && results[0] === GameColor.RED;
                const np = [...players]; let payout = 0;

                COLORS.forEach(c => {
                    const m = results.filter(r => r === c).length;
                    if (m > 0) bets[c].forEach(b => { const w = b.amount * m; const idx = np.findIndex(p => p.id === b.playerId); if(idx !== -1) np[idx].wallet += (b.amount + w); payout += w; });
                });
                if (isPair) sideBets['PAIR'].forEach(b => { const w = b.amount * 2; const idx = np.findIndex(p => p.id === b.playerId); if(idx !== -1) np[idx].wallet += (b.amount + w); payout += w; });
                if (isTriple) sideBets['TRIPLE'].forEach(b => { const w = b.amount * 25; const idx = np.findIndex(p => p.id === b.playerId); if(idx !== -1) np[idx].wallet += (b.amount + w); payout += w; });

                if (isJackpot) { const split = Math.floor(jackpot / np.length); np.forEach(p => p.wallet += split); setJackpot(INITIAL_JACKPOT); setMessage("üö® JACKPOT! TRIPLE REDS! üö®"); }
                else { setMessage(payout > 0 ? (isTriple ? "TRIPLE HIT! HUGE PAYOUT!" : `WINNERS: ${winners.join(', ').toUpperCase()}!`) : "NO WINNERS. HOUSE WINS."); }

                setPlayers(np);
                const ne = { id: uuidv4(), roundNumber: history.length + 1, diceResults: results, timestamp: new Date().toISOString() };
                setHistory([ne, ...history].slice(0, 50));
                const host = np.find(p => !p.isGuest); if (host) setWalletHistory([...walletHistory, host.wallet]);
            };

            return (
                <div className="relative w-full max-w-6xl mx-auto flex flex-col gap-4 p-2 sm:p-4 pb-20">
                    <div className="flex flex-col sm:flex-row justify-between items-stretch gap-4 bg-gray-900 p-2 rounded-lg border border-gray-700 shadow-xl z-20">
                        <div className="flex items-center gap-2">
                            <button onClick={onExit} className="text-gray-400 hover:text-white font-mono text-xs px-3 py-1 border border-transparent hover:border-gray-500 rounded transition-all font-bold">&lt; EXIT</button>
                            <div className="flex gap-2"><button onClick={() => setIsStatsOpen(true)} className="bg-gray-800 text-cyan-400 font-mono text-xs px-3 py-1 rounded border border-cyan-900 hover:bg-gray-700 font-bold shadow-md">STATS</button><button onClick={() => setIsHistoryOpen(true)} className="bg-gray-800 text-yellow-400 font-mono text-xs px-3 py-1 rounded border border-yellow-900 hover:bg-gray-700 font-bold shadow-md">LOGS</button></div>
                        </div>
                        <div className="flex-1 flex items-center justify-center bg-black border border-purple-900 rounded px-4 py-2 shadow-[0_0_20px_rgba(88,28,135,0.5)]"><div className="text-center"><span className="block text-[9px] text-purple-400 font-mono tracking-[0.3em] uppercase">Progressive Jackpot</span><span className="block text-2xl font-mono font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 drop-shadow-md">NT$ {jackpot.toLocaleString()}</span></div></div>
                    </div>

                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 z-10">
                        {players.map((p) => {
                            const active = p.id === activePlayerId; const th = PLAYER_THEMES[p.theme];
                            return <div key={p.id} onClick={() => roundActive && setActivePlayerId(p.id)} className={`relative rounded-lg p-3 border-2 transition-all cursor-pointer overflow-hidden ${active ? `${th.bg} ${th.border} z-10 scale-105 shadow-2xl brightness-110` : 'bg-gray-900 border-gray-700 hover:border-gray-500 hover:bg-gray-800'}`}><div className="flex flex-col items-center"><span className={`font-alfa text-xs uppercase tracking-wide ${active ? 'text-white' : 'text-gray-400'}`}>{p.name}</span><span className={`font-mono text-lg font-bold mt-1 ${active ? th.text : 'text-gray-500'}`}>NT$ {p.wallet}</span></div></div>;
                        })}
                    </div>

                    <div className="bg-gray-900 border border-gray-700 rounded-lg p-3 flex flex-col sm:flex-row items-center justify-between gap-4 shadow-lg z-10">
                        <div className="flex items-center gap-3 w-full overflow-hidden"><span className="text-[10px] font-mono text-gray-500 uppercase tracking-widest whitespace-nowrap font-bold">LIVE TREND:</span><div className="flex gap-2 overflow-x-auto scrollbar-hide items-center h-8">{history.slice(0, 15).map(h => (<div key={h.id} className="flex flex-col gap-0.5">{h.diceResults.slice(0, 1).map((c, i) => (<div key={i} className={`w-3 h-3 rounded-full ${COLOR_TAILWIND_MAP[c]} shadow-md border border-black/20`} />))}</div>))}{history.length === 0 && <span className="text-[10px] text-gray-700 font-mono">NO DATA</span>}</div></div>
                        {hotColor && <div className="flex gap-4 border-l border-gray-700 pl-4 shrink-0"><div className="flex items-center gap-2"><span className="text-lg grayscale-[0.2]">üî•</span><div className={`w-6 h-6 rounded shadow-md border border-gray-500 ${COLOR_TAILWIND_MAP[hotColor]}`}></div></div><div className="flex items-center gap-2"><span className="text-lg grayscale-[0.2]">‚ùÑÔ∏è</span><div className={`w-6 h-6 rounded shadow-md border border-gray-500 ${COLOR_TAILWIND_MAP[coldColor]}`}></div></div></div>}
                    </div>

                    <div className="text-center py-1 h-6 z-10"><p className="font-mono text-cyan-300 text-sm tracking-[0.2em] animate-pulse uppercase font-bold drop-shadow-md">{'>'} {message}</p></div>

                    <div className="flex flex-col lg:flex-row gap-6 z-10">
                        <div className="lg:w-1/3 flex flex-col gap-6">
                            <div className="h-32 sm:h-40 flex items-center justify-center gap-6 perspective-[800px] bg-gray-900 rounded-xl border border-gray-700 shadow-xl relative overflow-hidden"><div className="absolute inset-0 bg-black/40"></div>{diceResults.map((r, i) => <Die key={i} color={r} isRolling={isRolling} />)}</div>
                            <div className="flex gap-4 h-full"><div className="flex-1"><SideBetSquare type="PAIR" payoutText="2x" bets={sideBets['PAIR']} players={players} activePlayer={activePlayer} onPlaceBet={placeSideBet} disabled={!roundActive || isRolling} isWinner={winningSideBets.includes('PAIR')} /></div><div className="flex-1"><SideBetSquare type="TRIPLE" payoutText="25x" bets={sideBets['TRIPLE']} players={players} activePlayer={activePlayer} onPlaceBet={placeSideBet} disabled={!roundActive || isRolling} isWinner={winningSideBets.includes('TRIPLE')} /></div></div>
                        </div>
                        <div className="lg:w-2/3 grid grid-cols-3 gap-3 sm:gap-4">{COLORS.map((c) => (<BettingSquare key={c} color={c} bets={bets[c]} players={players} activePlayer={activePlayer} onPlaceBet={placeBet} disabled={!roundActive || isRolling} isWinner={winningColors.includes(c)} />))}</div>
                    </div>

                    <div className="mt-2 z-10"><Controls selectedChip={selectedChip} onSelectChip={setSelectedChip} onRoll={rollDice} onClear={clearAllBets} onNewRound={startNewRound} onUndo={undoLastBet} onDouble={doubleBets} canRoll={roundActive && totalBetAmount > 0 && !isRolling} canClear={roundActive && totalBetAmount > 0} canBet={roundActive} canUndo={betStack.length > 0} canDouble={totalBetAmount > 0 && activePlayer.wallet >= totalBetAmount} roundActive={roundActive} activePlayer={activePlayer} /></div>
                    <HistoryModal isOpen={isHistoryOpen} onClose={() => setIsHistoryOpen(false)} history={history} />
                    {currentUser && <StatsModal isOpen={isStatsOpen} onClose={() => setIsStatsOpen(false)} walletHistory={walletHistory} username={currentUser.username} />}
                </div>
            );
        };

        // --- APP ROOT ---
        const App = () => {
            const [view, setView] = useState('LOGIN');
            const [loginMode, setLoginMode] = useState('LOGIN');
            const [usernameInput, setUsernameInput] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            const [allUsers, setAllUsers] = useState({});
            const [currentUser, setCurrentUser] = useState(null);
            const [lobbyPlayers, setLobbyPlayers] = useState([]);
            const [guestNameInput, setGuestNameInput] = useState('');

            useEffect(() => { const s = localStorage.getItem(STORAGE_KEY); if (s) try { setAllUsers(JSON.parse(s)); } catch (e) { localStorage.removeItem(STORAGE_KEY); } }, []);
            const saveToStorage = (users) => { localStorage.setItem(STORAGE_KEY, JSON.stringify(users)); setAllUsers(users); };

            const handleAuth = (e) => { e.preventDefault(); setErrorMsg(''); const name = usernameInput.trim().toUpperCase(); if (!name) return;
                if (loginMode === 'LOGIN') { if (allUsers[name]) { const u = allUsers[name]; const nu = { ...u, lastLogin: new Date().toISOString() }; const db = { ...allUsers, [name]: nu }; saveToStorage(db); setCurrentUser(nu); setView('MENU'); } else { setErrorMsg('ERROR: USER_NOT_FOUND. CHECK CREDENTIALS.'); } } 
                else { if (allUsers[name]) { setErrorMsg('ERROR: IDENTITY_ALREADY_EXISTS.'); } else { const nu = { username: name, wallet: 1000, history: [], walletHistory: [1000], lastLogin: new Date().toISOString() }; const db = { ...allUsers, [name]: nu }; saveToStorage(db); setCurrentUser(nu); setView('MENU'); } }
            };
            const handleSyncData = (d) => { if (!currentUser) return; const su = { ...currentUser, ...d }; setCurrentUser(su); const db = { ...allUsers, [currentUser.username]: su }; saveToStorage(db); };
            const handleLogout = () => { setCurrentUser(null); setUsernameInput(''); setErrorMsg(''); setView('LOGIN'); };
            const initLobby = () => { if (!currentUser) return; setLobbyPlayers([{ id: uuidv4(), name: currentUser.username, wallet: currentUser.wallet, isGuest: false, theme: 'cyan' }]); setGuestNameInput(''); setView('LOBBY'); };
            const addGuest = (e) => { e.preventDefault(); if (!guestNameInput.trim() || lobbyPlayers.length >= 4) return; const t = ['cyan', 'pink', 'green', 'orange'][lobbyPlayers.length % 4]; const ng = { id: uuidv4(), name: guestNameInput.trim().toUpperCase(), wallet: 1000, isGuest: true, theme: t }; setLobbyPlayers([...lobbyPlayers, ng]); setGuestNameInput(''); };
            const removePlayer = (id) => { if (lobbyPlayers.length <= 1) return; setLobbyPlayers(lobbyPlayers.filter(p => p.id !== id)); };
            const startGame = () => { setView('GAME'); };

            return (
                <div className="min-h-screen font-sans selection:bg-neon-cyan selection:text-black flex flex-col overflow-x-hidden relative bg-[#050a10]">
                    <div className="fixed inset-0 pointer-events-none z-0"><div className="absolute inset-0 bg-gradient-to-b from-[#02060c] to-[#111827]"></div><div className="perspective-grid"><div className="moving-grid"></div></div><div className="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-purple-600/20 blur-[100px] rounded-full animate-pulse-fast"></div><div className="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-cyan-600/20 blur-[100px] rounded-full animate-pulse-fast" style={{animationDelay: '1s'}}></div><div className="absolute inset-0 overflow-hidden">{[...Array(6)].map((_, i) => (<div key={i} className="floating-shape rounded-lg border-neon-cyan/20" style={{ left: `${10 + Math.random() * 80}%`, animationDelay: `${Math.random() * 5}s`, animationDuration: `${10 + Math.random() * 10}s`, width: `${30 + Math.random() * 40}px`, height: `${30 + Math.random() * 40}px`, background: i % 2 === 0 ? 'rgba(0, 240, 255, 0.05)' : 'rgba(236, 72, 153, 0.05)' }} />))}</div></div>
                    <main className="container mx-auto z-10 flex-1 flex flex-col relative h-full">
                        {view === 'LOGIN' && (
                            <div className="flex-1 flex flex-col items-center justify-center p-4 animate-in fade-in duration-700 min-h-screen"><div className="text-center mb-10 relative group"><h1 className="absolute inset-0 text-7xl sm:text-9xl font-alfa text-red-500 blur-[2px] opacity-50 animate-pulse transform translate-x-1">BET-O-BET</h1><h1 className="absolute inset-0 text-7xl sm:text-9xl font-alfa text-cyan-500 blur-[2px] opacity-50 animate-pulse transform -translate-x-1" style={{animationDelay: '0.1s'}}>BET-O-BET</h1><h1 className="relative text-7xl sm:text-9xl font-alfa text-transparent bg-clip-text bg-gradient-to-b from-white via-gray-200 to-gray-400 drop-shadow-[0_5px_5px_rgba(0,0,0,1)] z-10">BET-O-BET</h1><div className="mt-6 flex flex-col items-center gap-2"><div className="h-px w-32 bg-gradient-to-r from-transparent via-cyan-500 to-transparent"></div><p className="text-cyan-400 font-mono tracking-[0.5em] text-xs sm:text-sm uppercase animate-pulse">Digital Casino Protocol</p><div className="mt-2 text-sm font-mono text-cyan-500/60 tracking-[0.2em] hover:text-cyan-400 transition-colors cursor-default">Â•éÂ¶≤ÂÖí / dharls</div><div className="h-px w-32 bg-gradient-to-r from-transparent via-cyan-500 to-transparent mt-1"></div></div></div><div className="w-full max-w-md relative backdrop-blur-xl perspective-[1000px]"><div className="flex w-full px-2 transform translate-y-[2px]"><button onClick={() => { setLoginMode('LOGIN'); setErrorMsg(''); }} className={`flex-1 h-12 relative group focus:outline-none transition-all duration-300 ${loginMode === 'LOGIN' ? 'z-20 scale-105' : 'z-10 opacity-70 hover:opacity-100'}`}><div className={`absolute inset-0 transform skew-x-12 rounded-t-md border-t border-l border-r transition-colors duration-300 ${loginMode === 'LOGIN' ? 'bg-gray-900/90 border-cyan-500 shadow-[0_-5px_20px_rgba(0,240,255,0.3)]' : 'bg-black/40 border-gray-600'}`} /><span className={`relative z-10 font-mono font-bold tracking-widest text-sm flex items-center justify-center h-full w-full transform -skew-x-12 ${loginMode === 'LOGIN' ? 'text-cyan-400' : 'text-gray-400'}`}>// LOGIN</span></button><div className="w-2"></div><button onClick={() => { setLoginMode('REGISTER'); setErrorMsg(''); }} className={`flex-1 h-12 relative group focus:outline-none transition-all duration-300 ${loginMode === 'REGISTER' ? 'z-20 scale-105' : 'z-10 opacity-70 hover:opacity-100'}`}><div className={`absolute inset-0 transform -skew-x-12 rounded-t-md border-t border-l border-r transition-colors duration-300 ${loginMode === 'REGISTER' ? 'bg-gray-900/90 border-pink-500 shadow-[0_-5px_20px_rgba(236,72,153,0.3)]' : 'bg-black/40 border-gray-600'}`} /><span className={`relative z-10 font-mono font-bold tracking-widest text-sm flex items-center justify-center h-full w-full transform skew-x-12 ${loginMode === 'REGISTER' ? 'text-pink-500' : 'text-gray-400'}`}>// REGISTER</span></button></div><div className={`relative z-20 bg-gray-900/90 border-x border-b p-8 rounded-b-xl shadow-2xl overflow-hidden ${loginMode === 'LOGIN' ? 'border-cyan-500/50' : 'border-pink-500/50'}`}><div className="absolute inset-0 scanlines opacity-10 pointer-events-none"></div><div className={`absolute top-0 left-0 w-full h-[2px] shadow-[0_0_10px_currentColor] ${loginMode === 'LOGIN' ? 'bg-cyan-500 text-cyan-500' : 'bg-pink-500 text-pink-500'}`}></div><div className="relative z-10 flex flex-col gap-6"><div className="text-center"><h2 className={`font-mono text-xs tracking-[0.2em] uppercase mb-1 ${loginMode === 'LOGIN' ? 'text-cyan-400' : 'text-pink-400'}`}>{loginMode === 'LOGIN' ? 'Authentication Required' : 'New User Protocol'}</h2><div className="h-px w-full bg-gradient-to-r from-transparent via-gray-700 to-transparent"></div></div><form onSubmit={handleAuth} className="flex flex-col gap-5"><div className="relative group"><input type="text" value={usernameInput} onChange={(e) => setUsernameInput(e.target.value)} placeholder="ENTER USER ID" className={`w-full bg-black/50 border rounded px-4 py-4 text-white font-mono text-lg text-center focus:outline-none transition-all placeholder:text-gray-700 uppercase tracking-widest ${loginMode === 'LOGIN' ? 'border-gray-700 focus:border-cyan-500 focus:shadow-[0_0_15px_rgba(6,182,212,0.3)]' : 'border-gray-700 focus:border-pink-500 focus:shadow-[0_0_15px_rgba(236,72,153,0.3)]'}`} autoFocus maxLength={15} /><div className="absolute top-0 left-0 w-2 h-2 border-t border-l border-white/30"></div><div className="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-white/30"></div></div>{errorMsg && <div className="bg-red-500/10 border border-red-500/50 p-2 text-center text-red-400 font-mono text-[10px] animate-pulse">‚ö† {errorMsg}</div>}<button type="submit" disabled={!usernameInput.trim()} className={`w-full py-4 font-alfa text-xl rounded shadow-lg transition-all border relative overflow-hidden group ${!usernameInput.trim() ? 'bg-gray-800 text-gray-600 border-gray-700 cursor-not-allowed' : loginMode === 'LOGIN' ? 'bg-cyan-900/80 hover:bg-cyan-800 text-cyan-100 border-cyan-500 hover:shadow-[0_0_20px_rgba(6,182,212,0.4)]' : 'bg-pink-900/80 hover:bg-pink-800 text-pink-100 border-pink-500 hover:shadow-[0_0_20px_rgba(236,72,153,0.4)]'}`}><span className="relative z-10">{loginMode === 'LOGIN' ? 'CONNECT SYSTEM' : 'INITIALIZE'}</span><div className="absolute top-0 -left-[100%] w-full h-full bg-gradient-to-r from-transparent via-white/10 to-transparent transform -skew-x-12 group-hover:left-[100%] transition-all duration-700"></div></button></form></div></div></div><div className="mt-12 text-[10px] font-mono text-gray-600 uppercase tracking-[0.3em]">System Online ‚Ä¢ v2.6.4 ‚Ä¢ Ready</div></div>
                        )}
                        {view === 'MENU' && currentUser && (
                            <div className="flex-1 flex flex-col items-center justify-center gap-8 p-4 animate-in fade-in zoom-in-95 duration-300 min-h-screen"><div className="text-center relative"><div className="tech-border bg-black/80 px-12 py-8 relative backdrop-blur-md"><div className="absolute top-2 right-2 flex gap-1"><div className="w-2 h-2 rounded-full bg-red-500"></div><div className="w-2 h-2 rounded-full bg-yellow-500"></div><div className="w-2 h-2 rounded-full bg-green-500"></div></div><h2 className="text-xs text-cyan-400 font-mono tracking-widest mb-4 border-b border-gray-800 pb-2">OPERATOR IDENTIFIED</h2><div className="text-5xl sm:text-7xl text-white font-bold font-alfa neon-text-glow uppercase tracking-wider">{currentUser.username}</div><div className="mt-6 flex justify-center gap-4"><div className="bg-gray-900 border border-gray-700 px-4 py-2 rounded text-cyan-300 font-mono text-sm">WALLET: <span className="text-white font-bold text-lg">NT$ {currentUser.wallet.toLocaleString()}</span></div></div></div></div><div className="flex flex-col gap-6 w-full max-w-lg z-10 mt-8"><button onClick={initLobby} className="group relative w-full h-32 bg-gray-900/80 clip-corner-br flex items-center overflow-hidden transition-all hover:scale-[1.02] border-l-4 border-l-green-500 border-t border-r border-b border-white/10 hover:border-green-400 backdrop-blur-sm"><div className="absolute inset-0 bg-green-500/5 group-hover:bg-green-500/10 transition-colors"></div><div className="pl-10 flex flex-col items-start relative z-10"><span className="text-4xl font-alfa text-white tracking-wider group-hover:text-green-300 transition-colors drop-shadow-md">ENTER GAME</span><span className="text-xs font-mono text-green-400 uppercase tracking-[0.3em] mt-1 group-hover:translate-x-2 transition-transform">Solo or Local Multiplayer &gt;&gt;</span></div><div className="absolute right-8 opacity-20 group-hover:opacity-50 transition-opacity"><div className="w-16 h-16 border-4 border-green-500 rounded-lg transform rotate-12"></div></div></button></div><div className="mt-16"><button onClick={handleLogout} className="px-8 py-3 border border-red-500/30 bg-black/50 hover:bg-red-900/20 rounded-full text-xs font-mono text-red-400 uppercase tracking-widest transition-all hover:shadow-[0_0_15px_rgba(220,38,38,0.2)]">[ TERMINATE SESSION ]</button></div></div>
                        )}
                        {view === 'LOBBY' && (
                            <div className="flex-1 flex flex-col items-center justify-center p-4 animate-in slide-in-from-right duration-300 min-h-screen"><div className="w-full max-w-3xl bg-gray-900/95 border border-white/10 rounded-xl p-8 shadow-2xl relative overflow-hidden backdrop-blur-xl"><div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 via-purple-500 to-yellow-500 animate-pulse"></div><div className="flex justify-between items-end mb-8 border-b border-white/5 pb-4"><div><h2 className="text-4xl font-alfa text-white">LOBBY</h2><p className="font-mono text-cyan-400 text-xs tracking-widest mt-1">CONFIGURE SQUAD PARAMETERS</p></div><div className="text-right"><span className="text-xs font-mono text-gray-500">PLAYERS</span><div className="text-2xl font-mono text-white">{lobbyPlayers.length} / 4</div></div></div><div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">{lobbyPlayers.map((player, idx) => (<div key={player.id} className="relative bg-black/60 border border-white/10 p-4 rounded flex items-center justify-between group hover:border-white/30 transition-all"><div className="flex items-center gap-4"><div className={`w-10 h-10 rounded flex items-center justify-center font-bold text-white text-lg shadow-lg bg-gradient-to-br from-${player.theme === 'cyan' ? 'cyan-500' : player.theme === 'pink' ? 'pink-500' : player.theme === 'green' ? 'green-500' : 'orange-500'} to-black border border-white/20`}>{idx + 1}</div><div className="flex flex-col"><span className="font-alfa text-white tracking-wide uppercase text-lg">{player.name}</span><span className="text-[10px] font-mono text-gray-400">{player.isGuest ? 'GUEST ACCOUNT' : 'HOST COMMANDER'}</span></div></div>{player.isGuest && (<button onClick={() => removePlayer(player.id)} className="w-8 h-8 flex items-center justify-center bg-red-900/30 text-red-500 hover:bg-red-500 hover:text-white rounded transition-colors text-xl font-bold">√ó</button>)}</div>))}{lobbyPlayers.length < 4 && (<form onSubmit={addGuest} className="bg-white/5 border-2 border-dashed border-white/10 hover:border-green-500/50 p-4 rounded flex items-center gap-3 transition-colors group cursor-text"><div className="w-10 h-10 rounded border-2 border-dashed border-gray-600 flex items-center justify-center text-gray-600 group-hover:text-green-500 group-hover:border-green-500 transition-colors">+</div><input className="bg-transparent border-none text-white placeholder-gray-600 focus:outline-none font-mono uppercase text-sm w-full h-full" placeholder="ENTER GUEST NAME..." value={guestNameInput} onChange={(e) => setGuestNameInput(e.target.value)} maxLength={12} /><button type="submit" className="text-gray-500 hover:text-green-400 font-bold px-4">ADD</button></form>)}</div><div className="flex gap-4 pt-4 border-t border-white/5"><button onClick={() => setView('MENU')} className="flex-1 py-4 bg-gray-800 hover:bg-gray-700 text-gray-300 font-mono tracking-widest rounded transition-all border border-transparent hover:border-gray-500">ABORT</button><button onClick={startGame} className="flex-[2] py-4 bg-gradient-to-r from-cyan-700 to-blue-700 hover:from-cyan-600 hover:to-blue-600 text-white font-alfa tracking-widest text-xl rounded shadow-[0_0_20px_rgba(0,0,0,0.5)] transition-all hover:scale-[1.01]">LAUNCH GAME</button></div></div></div>
                        )}
                        {view === 'GAME' && currentUser && (
                            <div className="flex-1 animate-in fade-in slide-in-from-bottom-4 duration-500 w-full"><Game initialPlayers={lobbyPlayers} currentUser={currentUser} onSync={handleSyncData} onExit={() => setView('MENU')} /></div>
                        )}
                    </main>
                    <footer className="w-full bg-black/90 border-t border-white/10 py-3 px-6 flex flex-col sm:flex-row justify-between items-center text-[10px] font-mono text-gray-600 uppercase tracking-widest z-50 backdrop-blur-md gap-2"><div className="flex items-center gap-4"><span>System Ver: 3.0.0-NEON</span><div className="h-3 w-px bg-gray-700 hidden sm:block"></div><span className="text-gray-500"><span className="text-gray-400 hover:text-white cursor-help transition-colors">Â•éÂ¶≤ÂÖí / dharls</span></span></div><span className="flex items-center gap-2"><div className="w-1 h-1 bg-green-500 rounded-full animate-pulse"></div> Online // {loginMode}</span></footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>